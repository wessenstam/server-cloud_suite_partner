.. _cl5:

---------------------
Server Suite with CIP
---------------------

Introduction
------------
Server Suite leverages CIP to enable MFA at System Login, MFA at privilege elevation and workflow for just in time access.
Each Server Suite user must have a profile in CIP to achieve the mentioned features.

This lab will cover:

1. Apply MFA at system Login for Server Suite agents
2. Apply MFA at Privilege Elevation for Server Suite agents
3. Configure workflow for automatic time-based role assignment for Server Suite Agent.

.. note::
    Estimated time to complete this lab: **60 minutes**

------

Systems used in this lab:

- apps-server.greensafe.lab
- db-server.greensafe.lab
- db-unix.greensafe.lab
- \https://<tenant>.my.centrify.net

------

Apply MFA at system Login
*************************

Enable Server Suite MFA in CIP Portal
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

1. Login to your unique CIP Portal URL by navigating to https://<tenant>.my.centrify.net with your admin credentials on the **apps-server**.
2. From the main menu on the left, navigate to **Access > Policies**

   .. figure:: images/lab-001.png

3. Click on **Contractors Policy**
4. Under **Policy Settings**, expand **Authentication > Centrify Server Suite Agents**
5. Click on **Linux, UNIX and Windows Servers**

   .. figure:: images/lab-002.png

6. Select **Yes** next to **Enable authentication policy controls**
7. Under **Default Profile**, choose **Contactors MFA Profile**
8. Under **Apply Pass-Through Duration**, Keep the default **Never (Default)**
9. Click **Save**

   .. figure:: images/lab-003.png

11. On the same page, Under **Policy Settings**, expand **Authentication > Centrify Server Suite Agents**
12. Click on **Privilege Elevation**

    .. figure:: images/lab-004.png

13. Select **Yes** next to **Enable authentication policy controls**
14. Under **Default Profile**, choose **Contractors MFA Profile**
15. Click **Save**

    .. figure:: images/lab-005.png

16. In the same page, navigate to **Authentication > Centrify Services**

    .. figure:: images/lab-006.png

17. Scroll down to **Other Settings**
18. Ensure that **allow users without a valid authentication profile to login** is checked.
19. Click **Save**

Create Computer Role
^^^^^^^^^^^^^^^^^^^^

1. From the Main menu on the left, navigate to **Access > Roles**
2. Click **Add Role**
3. In the name field, type **Server Suite Computers**

   .. figure:: images/lab-007.png

4. Click on **Members**
5. Click **Add**
6. Make sure **Computers** is checked as filter
7. Search for **db-unix**, select it
8. Click **Add**

   .. figure:: images/lab-008.png

9. Repeat the same steps to add another computer as member **db-server**
10. Click on **Administrative Rights > Add**
11. Select **Computer Login and Privilege Elevation** and click **Add**

    .. figure:: images/lab-009.png

12. Click **Save** the Role



Assign User to role
^^^^^^^^^^^^^^^^^^^

1. From the main menu on the left, navigate to **Access > Roles**
2. Click on **Contractor Role**
3. Click on **Members**
4. Click **Add**
5. Search for user **badams@greensafe.lab**
6. **Select** the user, click **Add** and click **Save**

   .. figure:: images/lab-010.png

Create Userâ€™s MFA Profile
^^^^^^^^^^^^^^^^^^^^^^^^^

1. Launch **Chrome Incognito** session and navigate to the portal using *\https://<tenant>.my.centrify.net*
2. Login to The Portal with the following credentials:

   a. **Username:** badams@greensafe.lab
   b. **Password:** Provided by trainer

   .. Note::
       This is your first login to the portal using badams user. Thus, you will not be prompted for MFA according to the policy you configured that allows users without valid MFA profiles to login.

3. In the top right corner, click on the **Username > Profile**

   .. figure:: images/lab-011.png

4. Click on **Security Question**, type in security question and answer it and click **Save**
5. Click on **Mobile Authenticator App** to configure it
6. Scan the **QR Code** using your mobile device Authenticator Application
7. Enter the code generated by your Authenticator Application to verify
8. Click **Save**

Configure Server Suite Agents
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Server Suite Agents (Windows and UNIX) communicates with The Portal via available connectors. This communication requires the connector IWA root certificate to be trusted by the agents.

Windows Server
""""""""""""""

1. Login to **db-server.greensafe.lab** using the following credentials:

   a. **Username:** afoster
   b. **Password:** Provided by trainer

2. Launch **Google Chrome** and navigate to *\https://<tenant>.my.centrify.net* and login using your admin account
3. From the main menu on the left, navigate to **Settings > Network > Centrify Connectors**

   .. figure:: images/lab-012.png

4. Click on the available connector
5. Click on **IWA Service > Download your IWA root CA certificate**

   .. figure:: images/lab-013.png

6. Double click the downloaded certificate file to open it
7. Click **Install Certificate**

   .. figure:: images/lab-014.png

8. In **Store Location**, choose **Local Machine > Next**

   .. figure:: images/lab-015.png

9. In Certificate Store, choose **Place all certificates in the following store > Browse**

   .. figure:: images/lab-016.png

10. Click on **Trusted Root Certification Authority > Ok**

    .. figure:: images/lab-017.png

11. Click **Next > Finish**

Linux Server
""""""""""""

1. On the **db-server.greensafe.lab** 
2. Navigate to downloads folder, double click on **IwaTrustRoot.cer** file to open the previously downloaded Connector Certificate.
3. Click on **Details > Copy to file**

   .. figure:: images/lab-018.png

4. In the *Export Wizard*, Select **DER Encoded**.
5. Name the new certificate **Connector-cert > Save**

   .. figure:: images/lab-019.png

6. Launch **Server Manager > Manage > Add Roles & Features**
7. Click **Next** multiple times until **Select Feature Page > Check Group Policy Management > Continue installation**
8. From run open **Group Policy Management (gpmc.msc)**
9. Navigate to Forest: **greensafe.lab > Domains > greensafe.lab > Centrify**
10. Right Click **Centrify GPO > Edit**

    .. figure:: images/lab-020.png

11. Navigate to **Computer Configuration > Policies > Windows Settings > Security Settings > Public Key Policies > Trusted Root Certification Authorities**

    .. figure:: images/lab-021.png

12. Import the **Connector-cert.cer** certificate
13. Login to **db-unix** server using **root** and update the group policy using this command: ``adgpupdate``

Add Role Assignment to the user
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Bradley Adams user (badams) as a member of Team_Sales Security Group in Active Directory. In previous Server Suite labs , you have assigned this user the proper Unix & Windows Login roles, without MFA. To add MFA requirements and system login.

1. Login to **apps-server** using the following credentials:

   a. **Username:** afoster
   b. **Password:** Provided by the trainer

2. Open **Access Manager**
3. Navigate to **Global Zone > Child Zone > Windows Zone > Authorization > Role Assignment**

   .. figure:: images/lab-022.png

4. Right Click **Role Assignments > Assign Role**
5. Select **Require MFA for Login > Ok**
6. Click **Add AD Account > Find Team_Sales Group > Ok**

   .. figure:: images/lab-023.png

7. Navigate to **Global Zone > Child Zone > Unix Zone > Authorization > Role Assignment**
8. Right Click **Role Assignments > Assign Role**
9. Select **Require MFA for Login > Ok**
10. Add **Team_Sales Group**
11. Test Console login to **db-server & db-unix servers** using **badams**. You should be prompted for MFA. If any other account is logged in , sign them out.

    .. figure:: images/lab-025.png

    .. figure:: images/lab-024.png

Apply MFA at Privilege Elevation
********************************

MFA at privilege elevation is a feature enabled at the Role level in Access Manager. For this lab you are going to use an existing privilege elevation role, enable MFA requirements for it and assign it to Bradley Adams user.

Configure MFA for windows Application
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

1. From **Access Manager Console**, navigate to **Global Zone > Child Zones > Windows Zone Authorization > Windows Right Definitions > Applications**.

   .. figure:: images/lab-026.png

2. Right Click **Windows Firewall Management > Properties**
3. Open **Run As** tab
4. Select **Re-authenticate current user > Require multi-factor authentication**

   .. figure:: images/lab-027.png

5. **Ok**
6. Under **Windows Zone**, Right Click **Role Assignments > Assign Role**
7. Select **Firewall Management > Click Ok**
8. Click **Add AD Account**
9. Search for **badams** user > Click **Find Now**

   .. figure:: images/lab-028.png

10. Select **Bradley Adams** user and click **Ok > Ok**

Configure MFA for UNIX Command
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

1. Open **Unix Zone > Authorization > UNIX Right Definitions > Commands**

   .. figure:: images/lab-029.png

2. Right Click **Services Restart > Properties**
3. Click **Attributes** tab
4. Select **Re-authenticate current user > Require multi-factor authentication**

   .. figure:: images/lab-030.png

5. Click **Ok**
6. Navigate to **Unix Zone > Authorization > Role Assignment**
7. Right Click **Role Assignment** > Click **Assign Role**
8. Click **Unix Service Manager** > Click **Ok**
9. **Add AD Account > badams > Ok > Ok**

Test Elevation with MFA on UNIX
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

1. Login to **db-unix** server using **badams** credentials and MFA requirements
2. Restart the firewalld service using the following command

   .. code-block:: bash

       dzdo systemctl restart firewalld

   .. Note:: 
      If the command throws an error you are not allowed, log into the db-unix, and run the ``adflush`` command. Then retry the command. If still not working you can use ``dzinfo`` to see the allowed commands

3. Provide the password and MFA challenge will kick in
4. Close the session

Test Elevation with MFA on Windows
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

1. Login to **db-server** server using **badams** credentials & MFA requirements
2. From **Start Menu**, Click **Windows Administrative Tools**
3. Right click **Windows Firewall** and select **More > Open File Location**
4. Click on **Run with Privilege**
5. Reauthenticate using **badams** credentials and MFA

   .. Note:: 
      If the command throws an error you are not allowed, log into the db-unix, and run the ``dzrefresh`` command. Then retry the command.

Configure Workflow
******************

1. Login to your unique CIP URL https://<tenant>.my.centrify.net as admin user.
2. Navigate to **Resources > Domains**

   .. figure:: images/lab-031.png

3. Click on domain name **greensafe.lab**

   .. figure:: images/lab-032.png

4. Click **Permission > Add**

   .. figure:: images/lab-033.png

5. Search for your **CIP Admin User** > Click **Add**

   .. figure:: images/lab-034.png

6. Next to your admin username, check **Add Account**

   .. figure:: images/lab-035.png

7. Click **Save**
8. In the same page, Click on **Advanced**

   .. figure:: images/lab-036.png

9. Under **Domain Administrative Account**, Click **Set**

   .. figure:: images/lab-037.png

10. Choose **Active Directory Account > Select**

    .. figure:: images/lab-038.png

11. Search for **afoster** user, choose it > **Select**

    .. figure:: images/lab-039.png

12. Provide the password, click **Select** and click **Save**
13. In the same page, Click **Zone Role Workflow**

    .. figure:: images/lab-040.png

14. Check **Enable zone role requests from systems in this domain**

    .. figure:: images/lab-041.png

15. Under **Assignable Zone Roles**, Click **Add**
16. Search **Firewall**, Check **Firewall Management/Windows Zone**
17. Click **Add**

    .. figure:: images/lab-042.png

18. Under **Approver List**, Click **Add**
19. Choose **Specified user or Role** from dropdown list

    .. figure:: images/lab-043.png

20. Click **Add**

    .. figure:: images/lab-044.png

21. Search for your **CIP Admin** user and add it. This user will be approver.

    .. figure:: images/lab-045.png

22. Click **Add** and click **Save**
23. From the main menu on the left, navigate to **Resources > Systems**
24. Click **Add System**
25. Add **db-server.greensafe.lab** as shown in the image below

    .. figure:: images/lab-046.png

26. **Accept all defaults** and add the system using **Next** as many times till you see *Add System* and the **Finish** button. This will validate the credentials and the connection to the db-server. Click **Close** if all went ok
27. Click on db-server in the systems list

    .. figure:: images/lab-047.png

28. Click **Advanced**

    .. figure:: images/lab-048.png

29. Under **Domain Settings**, Click **Set**

    .. figure:: images/lab-049.png

30. Search for **greensafe.lab** and add it
31. **Save**
32. In the same page, click **Zone Role Workflow**

    .. figure:: images/lab-050.png

33. Check **Use Domain Administrative Account for Zone Role Workflow operations**
34. Change **Enable zone role requests from this system** to **Yes**
35. Accept All other defaults

    .. figure:: images/lab-051.png

36. Click **Save**
37. In the same page, click **Permissions**

    .. figure:: images/lab-052.png

38. Click **Add**
39. Search for **badams** user, check it and click **add**

    .. figure:: images/lab-053.png

40. Scroll to the right to check **Request Zone Role** for **badams** user

    .. figure:: images/lab-054.png

41. Click **Save**

Test the Automatic Role Assignment
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

1. In **Access Manager**, navigate to **Global Zone > Windows Zone > Authorization > Role Assignment**

   .. figure:: images/lab-055.png

2. **Delete** the *existing Role Firewall Management* assigned for **BAdams**
3. Open **Chrome Incognito** and login to the portal as **badams**.
4. From the main menu on the left, navigate to **Resources > Systems**
5. Right click **db-server**, click on **Request Zone Role**

   .. figure:: images/lab-056.png

6. Click on the available Role **Firewall Management/Windows Zone > Request**

   .. figure:: images/lab-057.png

7. In the request form, change the start time to 1 minute after the approval. Type a message in the *Reason Message* if required.
8. Click **Submit**

   .. figure:: images/lab-058.png

9. Switch to CIP Chrome session (logged in as your **admin** user / **Approver** user)
10. From the main menu on the left, navigate to **Access > Requests**

    .. figure:: images/lab-059.png

11. Click on the request to view the details.

    .. figure:: images/lab-060.png

12. Click **Approve** and click **Submit**
13. In **Access Manager Console**, Navigate to **Global Zone > Windows Zone > Computers > db-server > Role Assignment**

    .. figure:: images/lab-061.png

14. **Refresh the page**
15. Note the newly created role assignment with start and end date.

    .. figure:: images/lab-062.png

.. raw:: html

    <hr><CENTER>
    <H2 style="color:#00FF59">This concludes this lab</font>
    </CENTER>